name: Daily PR TIMES Crawling
on:
  schedule:
    # 한국 시간 오전 09:00 (UTC 00:00), 2026-12-31까지 실행
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      TZ: Asia/Seoul
    steps:
    - name: Check schedule end date (2026-12-31)
      id: check_end
      run: |
        if [ "$(date +%Y-%m-%d)" \> "2026-12-31" ]; then
          echo "skip=true" >> $GITHUB_OUTPUT
          echo "기한 종료: 본 워크플로는 2026-12-31까지 실행됩니다."
        else
          echo "skip=false" >> $GITHUB_OUTPUT
        fi

    - name: Checkout code
      if: steps.check_end.outputs.skip != 'true'
      uses: actions/checkout@v3

    - name: Set up Python
      if: steps.check_end.outputs.skip != 'true'
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install dependencies
      if: steps.check_end.outputs.skip != 'true'
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install gspread google-auth requests

    - name: Install Playwright Browsers
      if: steps.check_end.outputs.skip != 'true'
      run: |
        playwright install chromium --with-deps

    - name: Set file names
      if: steps.check_end.outputs.skip != 'true'
      run: |
        echo "TODAY=$(date +%F)" >> $GITHUB_ENV
        echo "RAW_FILE=raw_$(date +%F).csv" >> $GITHUB_ENV
        echo "FINAL_FILE=final_$(date +%F).csv" >> $GITHUB_ENV

    - name: Run Crawler
      if: steps.check_end.outputs.skip != 'true'
      run: python prtimes_beauty_today.py  # 상세 페이지 種類(개요·키워드·위치·소재) 수집 포함

    - name: Run Analyzer
      if: steps.check_end.outputs.skip != 'true'
      env:
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        GOOGLE_SERVICE_ACCOUNT_JSON: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_JSON }}
        SENDER_EMAIL: ${{ secrets.MAIL_USERNAME }}
        SENDER_PASSWORD: ${{ secrets.MAIL_PASSWORD }}
        RECIPIENT_EMAIL: ${{ secrets.MAIL_USERNAME }}
      run: |
        # 초기 10건 모두 영업 부적합이면 조기 중단됨
        # I열 한국 회사 여부 판단 시 N열(키워드) 한국 관련어 포함 시 '한국' 처리
        # 분석 완료 후 03_to_sheets.py 호출(Sheets 적재) 및 이메일 발송까지 수행
        ls -la "$RAW_FILE"
        python 02_analyzer.py "$RAW_FILE"

    - name: Relate 등록
      if: steps.check_end.outputs.skip != 'true'
      env:
        GOOGLE_SERVICE_ACCOUNT_JSON: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_JSON }}
        RELATE_API_KEY: ${{ secrets.RELATE_API_KEY }}
      run: python 04_to_relate.py