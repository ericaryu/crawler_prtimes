name: Daily PR TIMES Crawling
on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      TZ: Asia/Seoul
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Install Playwright Browsers
      run: |
        playwright install chromium --with-deps

    - name: Set file names
      run: |
        echo "TODAY=$(date +%F)" >> $GITHUB_ENV
        echo "RAW_FILE=raw_$(date +%F).csv" >> $GITHUB_ENV
        echo "FINAL_FILE=final_$(date +%F).csv" >> $GITHUB_ENV

    - name: Run Crawler
      run: python prtimes_beauty_today.py  # ìƒì„¸ í˜ì´ì§€ ç¨®é¡(ê°œìš”Â·í‚¤ì›Œë“œÂ·ìœ„ì¹˜Â·ì†Œì¬) ìˆ˜ì§‘ í¬í•¨

    - name: Run Analyzer
      env:
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      run: |
        # ì´ˆê¸° 10ê±´ ëª¨ë‘ ì˜ì—… ë¶€ì í•©ì´ë©´ ì¡°ê¸° ì¤‘ë‹¨ë¨
        # ç¨®é¡/í‚¤ì›Œë“œ/ê´€ë ¨ë§í¬ ë“± ë©”íƒ€ë°ì´í„° í•´ì„ ì»¬ëŸ¼ë„ finalì— í¬í•¨ë¨
        ls -la "$RAW_FILE"
        python 02_analyzer.py "$RAW_FILE"

    - name: Send Email with Date CSV ğŸŒ¸    # â† analyzer ì™„ë£Œ í›„ ì‹¤í–‰
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 465
        username: ${{ secrets.MAIL_USERNAME }}
        password: ${{ secrets.MAIL_PASSWORD }}
        subject: "ğŸŒ¸ ì£¼ì¸ë‹˜! ì˜¤ëŠ˜ì ë·°í‹° ë‰´ìŠ¤ ë¶„ì„ ì™„ë£Œëì–´ìš”! ğŸŒ¸"
        body: |
          ì•ˆë…•í•˜ì„¸ìš”, ì£¼ì¸ë‹˜! ğŸ¤–
          ì˜¤ëŠ˜ë„ ì •ì„±ê» ìˆ˜ì§‘Â·ë¶„ì„í•œ ë·°í‹° ë‰´ìŠ¤ CSV íŒŒì¼ì„ ì²¨ë¶€í•©ë‹ˆë‹¤.
          í–‰ë³µí•œ í•˜ë£¨ ë˜ì„¸ìš”! âœ¨
        to: ${{ secrets.MAIL_USERNAME }}
        from: "ëŒì•„ë¼ ì¼ë³¸ PR í¬ë¡¤ëŸ¬ ë´‡"
        # analyzer ì´í›„ ìƒì„±ëœ í•´ë‹¹ ë‚ ì§œ final íŒŒì¼ 1ê°œë§Œ ì²¨ë¶€
        attachments: "${{ env.FINAL_FILE }}"