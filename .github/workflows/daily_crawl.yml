name: Daily PR TIMES Crawling
on:
  schedule:
    # í•œêµ­ ì‹œê°„ ì˜¤ì „ 10:30 (UTC 01:30), 2026-12-31ê¹Œì§€ ì‹¤í–‰
    - cron: '30 1 * * *'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      TZ: Asia/Seoul
    steps:
    - name: Check schedule end date (2026-12-31)
      id: check_end
      run: |
        if [ "$(date +%Y-%m-%d)" \> "2026-12-31" ]; then
          echo "skip=true" >> $GITHUB_OUTPUT
          echo "ê¸°í•œ ì¢…ë£Œ: ë³¸ ì›Œí¬í”Œë¡œëŠ” 2026-12-31ê¹Œì§€ ì‹¤í–‰ë©ë‹ˆë‹¤."
        else
          echo "skip=false" >> $GITHUB_OUTPUT
        fi

    - name: Checkout code
      if: steps.check_end.outputs.skip != 'true'
      uses: actions/checkout@v3

    - name: Set up Python
      if: steps.check_end.outputs.skip != 'true'
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install dependencies
      if: steps.check_end.outputs.skip != 'true'
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Install Playwright Browsers
      if: steps.check_end.outputs.skip != 'true'
      run: |
        playwright install chromium --with-deps

    - name: Set file names
      if: steps.check_end.outputs.skip != 'true'
      run: |
        echo "TODAY=$(date +%F)" >> $GITHUB_ENV
        echo "RAW_FILE=raw_$(date +%F).csv" >> $GITHUB_ENV
        echo "FINAL_FILE=final_$(date +%F).csv" >> $GITHUB_ENV

    - name: Run Crawler
      if: steps.check_end.outputs.skip != 'true'
      run: python prtimes_beauty_today.py  # ìƒì„¸ í˜ì´ì§€ ç¨®é¡(ê°œìš”Â·í‚¤ì›Œë“œÂ·ìœ„ì¹˜Â·ì†Œì¬) ìˆ˜ì§‘ í¬í•¨

    - name: Run Analyzer
      if: steps.check_end.outputs.skip != 'true'
      env:
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      run: |
        # ì´ˆê¸° 10ê±´ ëª¨ë‘ ì˜ì—… ë¶€ì í•©ì´ë©´ ì¡°ê¸° ì¤‘ë‹¨ë¨
        # Iì—´ í•œêµ­ íšŒì‚¬ ì—¬ë¶€ íŒë‹¨ ì‹œ Nì—´(í‚¤ì›Œë“œ) í•œêµ­ ê´€ë ¨ì–´ í¬í•¨ ì‹œ 'í•œêµ­' ì²˜ë¦¬
        ls -la "$RAW_FILE"
        python 02_analyzer.py "$RAW_FILE"

    - name: Send Email with Date CSV ğŸŒ¸
      if: steps.check_end.outputs.skip != 'true'
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 465
        username: ${{ secrets.MAIL_USERNAME }}
        password: ${{ secrets.MAIL_PASSWORD }}
        subject: "ğŸŒ¸ ì£¼ì¸ë‹˜! ì˜¤ëŠ˜ì ë·°í‹° ë‰´ìŠ¤ ë¶„ì„ ì™„ë£Œëì–´ìš”! ğŸŒ¸"
        body: |
          ì•ˆë…•í•˜ì„¸ìš”, ì£¼ì¸ë‹˜! ğŸ¤–
          ì˜¤ëŠ˜ë„ ì •ì„±ê» ìˆ˜ì§‘Â·ë¶„ì„í•œ ë·°í‹° ë‰´ìŠ¤ CSV íŒŒì¼ì„ ì²¨ë¶€í•©ë‹ˆë‹¤.
          í–‰ë³µí•œ í•˜ë£¨ ë˜ì„¸ìš”! âœ¨
        to: ${{ secrets.MAIL_USERNAME }}
        from: "ëŒì•„ë¼ ì¼ë³¸ PR í¬ë¡¤ëŸ¬ ë´‡"
        # analyzer ì´í›„ ìƒì„±ëœ í•´ë‹¹ ë‚ ì§œ final íŒŒì¼ 1ê°œë§Œ ì²¨ë¶€
        attachments: "${{ env.FINAL_FILE }}"